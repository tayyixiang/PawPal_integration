@page "/admin/applications/review/{Id:int}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using PawPal_integration.Domain
@using PawPal_integration.Data
@inject PawPalContext Context
@inject NavigationManager Nav
@inject AuthenticationStateProvider Auth
@attribute [Authorize(Roles = "Administrator")]

<PageTitle>Review Application</PageTitle>

<div class="container py-4">
    <a href="/admin/applications" class="btn btn-outline-secondary mb-3">&larr; Back to List</a>

    @if (App == null)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Applicant: @App.FullName</h5>
                        <span class="badge bg-info text-dark">Pet: @(App.Pet?.Name ?? "Unknown")</span>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-4">Email/User</dt>
                            <dd class="col-sm-8">@App.CreatedBy</dd>

                            <dt class="col-sm-4">Phone</dt>
                            <dd class="col-sm-8">@App.PhoneNumber</dd>

                            <dt class="col-sm-4">Housing</dt>
                            <dd class="col-sm-8">@App.HousingType (Landlord Approval: @(App.HasLandlordOrFamilyApproval ? "Yes" : "No"))</dd>

                            <dt class="col-sm-4">Pet Experience</dt>
                            <dd class="col-sm-8">
                                Owned Before: @(App.CurrentlyOwnPets ? "Yes" : "No") <br />
                                <small class="text-muted">@App.PetExperienceDetails</small>
                            </dd>

                            <dt class="col-sm-4">Why Adopt?</dt>
                            <dd class="col-sm-8">@App.ReasonForAdoption</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm sticky-top" style="top: 2rem;">
                    <div class="card-body">
                        <h5 class="card-title">Decision</h5>
                        <p class="mb-3">
                            Current Status:
                            <span class="fw-bold @(App.Status == "Approved" ? "text-success" : App.Status == "Rejected" ? "text-danger" : "text-warning")">
                                @App.Status
                            </span>
                        </p>

                        @if (App.Pet?.AdoptionStatus == "Adopted" && App.Status != "Approved")
                        {
                            <div class="alert alert-danger small">
                                <strong>Warning:</strong> This pet has already been marked as 'Adopted'.
                            </div>
                        }

                        <div class="mb-3">
                            <label class="form-label small text-muted">Admin Remarks</label>
                            <textarea class="form-control" rows="3" @bind="App.AdminRemarks" placeholder="Internal notes..."></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            @if (App.Status == "Pending")
                            {
                                <button class="btn btn-success" @onclick='() => ProcessApplication("Approved")'>
                                    <i class="bi bi-check-lg"></i> Approve Adoption
                                </button>
                                <button class="btn btn-danger" @onclick='() => ProcessApplication("Rejected")'>
                                    <i class="bi bi-x-lg"></i> Reject
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-outline-secondary" disabled>Application Finalized</button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int Id { get; set; }
    private AdoptionApplication? App;

    protected override async Task OnInitializedAsync()
    {
        App = await Context.AdoptionApplications
            .Include(a => a.Pet)
            .FirstOrDefaultAsync(a => a.Id == Id);
    }

    private async Task ProcessApplication(string newStatus)
    {
        if (App == null) return;

        // 1. Update Application Status
        App.Status = newStatus;

        var authState = await Auth.GetAuthenticationStateAsync();
        App.ReviewedByAdminId = authState.User.Identity?.Name;
        App.ReviewedDateTime = DateTime.Now;

        // 2. AUTOMATION: If Approved, Mark Pet as Adopted
        if (newStatus == "Approved" && App.Pet != null)
        {
            App.Pet.AdoptionStatus = "Adopted";
            Context.Pets.Update(App.Pet); // Explicitly track pet update
        }

        // 3. Save All Changes
        await Context.SaveChangesAsync();

        Nav.NavigateTo("/admin/applications");
    }
}