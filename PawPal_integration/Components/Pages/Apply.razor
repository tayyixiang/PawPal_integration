@page "/apply"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using PawPal_integration.Domain
@using PawPal_integration.Data
@inject PawPalContext Context
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<PageTitle>Apply for Adoption</PageTitle>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3>Adoption Application</h3>
                </div>
                <div class="card-body">
                    @if (Pet == null)
                    {
                        <p>Loading pet details...</p>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <strong>Applying for:</strong> @Pet.Name (@Pet.Breed)
                        </div>

                        <EditForm Model="Application" OnValidSubmit="SubmitApplication" FormName="applyForm">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger" />

                            <h5 class="mt-3">Contact Information</h5>
                            <div class="mb-3">
                                <label>Full Name</label>
                                <InputText @bind-Value="Application.FullName" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label>Phone Number</label>
                                <InputText @bind-Value="Application.PhoneNumber" class="form-control" />
                            </div>
                            <div class="mb-3">
                                <label>Address</label>
                                <InputTextArea @bind-Value="Application.Address" class="form-control" />
                            </div>

                            <h5 class="mt-3">Home Environment</h5>
                            <div class="mb-3">
                                <label>Housing Type</label>
                                <InputSelect @bind-Value="Application.HousingType" class="form-control">
                                    <option value="">-- Select --</option>
                                    <option value="HDB">HDB</option>
                                    <option value="Condo">Condo</option>
                                    <option value="Landed">Landed</option>
                                </InputSelect>
                            </div>
                            <div class="form-check mb-2">
                                <InputCheckbox @bind-Value="Application.HasLandlordOrFamilyApproval" class="form-check-input" />
                                <label class="form-check-label">I have approval from landlord/family</label>
                            </div>
                            <div class="form-check mb-2">
                                <InputCheckbox @bind-Value="Application.AnyoneAllergic" class="form-check-input" />
                                <label class="form-check-label">Is anyone in the household allergic?</label>
                            </div>

                            <h5 class="mt-3">Motivation</h5>
                            <div class="mb-3">
                                <label>Why do you want to adopt?</label>
                                <InputTextArea @bind-Value="Application.ReasonForAdoption" class="form-control" />
                            </div>

                            <button type="submit" class="btn btn-success w-100 mt-3">Submit Application</button>
                        </EditForm>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery]
    public int PetId { get; set; }

    [SupplyParameterFromForm]
    public AdoptionApplication Application { get; set; } = new();

    public Pet? Pet { get; set; }

    protected override async Task OnInitializedAsync()
    {
        // Fetch Pet details to display name
        Pet = await Context.Pets.FirstOrDefaultAsync(p => p.Id == PetId);

        if (Pet == null)
        {
            // If invalid Pet ID, go back
            NavigationManager.NavigateTo("/pets");
        }
    }

    private async Task SubmitApplication()
    {
        // 1. Get Current User
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirst(u => u.Type.Contains("nameidentifier"))?.Value;
        var userName = user.Identity?.Name ?? "Unknown";

        // 2. Fill System Fields
        Application.PetId = PetId;
        Application.AdopterId = userId ?? userName; // Store User ID
        Application.ApplicationDate = DateTime.Now;
        Application.Status = "Pending";
        Application.CreatedBy = userName;
        Application.UpdatedBy = userName;

        // 3. Save
        Context.AdoptionApplications.Add(Application);
        await Context.SaveChangesAsync();

        // 4. Redirect
        NavigationManager.NavigateTo("/adoptionapplications");
    }
}